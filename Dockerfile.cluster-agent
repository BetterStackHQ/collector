# Get Cluster Agent from official image
FROM ghcr.io/coroot/coroot-cluster-agent:1.2.4 AS cluster-agent

# Final stage - Using Debian 12.11-slim for minimal footprint
FROM debian:12.11-slim

# Install supervisor, ca-certificates, and curl
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        supervisor \
        ca-certificates \
        curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create necessary directories
RUN mkdir -p /etc/supervisor/conf.d /var/log/supervisor

# Copy Cluster Agent
COPY --from=cluster-agent --chmod=755 /usr/bin/coroot-cluster-agent /usr/local/bin/cluster-agent

# Copy control script
COPY --chmod=755 cluster-agent/cluster-collector.sh /cluster-collector.sh

# Copy supervisord configuration
COPY cluster-agent/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Default command
CMD ["supervisord", "-c", "/etc/supervisor/supervisord.conf"]