# eBPF container for Docker Swarm nodes
# Deploy with: docker compose -f docker-compose.swarm-ebpf.yml -p better-stack-ebpf up -d
#
# This runs outside of Docker Swarm as a regular docker-compose service because eBPF agent requires:
# - network_mode: host (for eBPF network tracing)
# - privileged: true (for eBPF access)
# - pid: host (for process visibility)
#
# These options are not supported in Docker Swarm services.

services:
  ebpf:
    image: ghcr.io/betterstackhq/collector-ebpf:latest
    container_name: better-stack-ebpf
    restart: always
    init: true
    stop_signal: SIGTERM
    stop_grace_period: 90s
    privileged: true
    pid: host
    uts: host
    network_mode: host
    mem_limit: 3072m
    healthcheck:
      test: ["CMD-SHELL", "if [ -x /var/lib/better-stack/ebpf/healthcheck.sh ]; then /var/lib/better-stack/ebpf/healthcheck.sh; else exit 0; fi"]
      interval: 30s
      timeout: 5s
      start_period: 60s
      retries: 2
    environment:
      # Set Go memory limit to slightly less than container limit
      - GOMEMLIMIT=1400MiB
      # Pass hostname of host machine to eBPF agent; needs `export HOSTNAME` before running `docker compose up`
      - HOSTNAME
      # Enable dockerprobe
      - ENABLE_DOCKERPROBE
      - INSTALLED_AS=swarm
    volumes:
      - /:/host:ro
      - /sys/kernel/tracing:/sys/kernel/tracing:rw
      - /sys/kernel/debug:/sys/kernel/debug:rw
      - /sys/kernel/security:/sys/kernel/security:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      # Docker socket for dockerprobe
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/better-stack:/var/lib/better-stack
